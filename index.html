<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Местим Всичко - Екип</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #f0f2f5; font-family: 'Segoe UI', sans-serif; padding-bottom: 50px; }
        .order-card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 15px; border-left: 6px solid #1a3c5a; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .btn-action { border-radius: 50px; padding: 12px; font-weight: bold; width: 100%; margin-top: 10px; }
        #loginScreen { height: 100vh; display: flex; align-items: center; justify-content: center; background: white; padding: 20px; text-align: center; }
    </style>
</head>
<body>

    <div id="loginScreen">
        <div>
            <i class="fas fa-truck-loading fa-4x text-primary mb-4"></i>
            <h3 class="fw-bold">Местим Всичко</h3>
            <p class="text-muted">Въведете вашия служебен имейл</p>
            <input type="email" id="emailInput" class="form-control mb-3 text-center" placeholder="name@gmail.com">
            <button class="btn btn-primary w-100 py-3 rounded-pill fw-bold" onclick="login()">ВХОД В СИСТЕМАТА</button>
        </div>
    </div>

    <div id="appScreen" style="display:none;" class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="m-0 fw-bold" id="userName">Здравей!</h4>
            <button class="btn btn-sm btn-outline-danger" onclick="location.reload()">Изход</button>
        </div>

        <h5 class="mb-3 text-muted"><i class="fas fa-calendar-day me-2"></i>Вашите задачи:</h5>
        <div id="myOrders"></div>
    </div>

    <!-- MODAL: CHECKLIST -->
    <div class="modal fade" id="checkModal" data-bs-backdrop="static" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered"><div class="modal-content p-4">
            <h4 class="text-center mb-4">Приключване</h4>
            <form id="checkForm">
                <input type="hidden" id="checkOrderId">
                <label class="mb-2">Униформа днес?</label>
                <select class="form-select mb-3" id="q_uniform"><option>Да</option><option>Не</option></select>
                
                <label class="mb-2">Работата днес беше:</label>
                <select class="form-select mb-3" id="q_load"><option>Лека</option><option>Нормална</option><option>Тежка</option></select>
                
                <label class="mb-2">Работа с екипа:</label>
                <select class="form-select mb-3" id="q_team"><option>Лека</option><option>Нормална</option><option>Трудна</option></select>
                
                <label class="mb-2">Работа с клиенти:</label>
                <select class="form-select mb-3" id="q_client"><option>Лека</option><option>Нормална</option><option>Трудна</option></select>

                <textarea class="form-control mb-3" id="q_notes" placeholder="Бележки (опционално)"></textarea>
                <button type="submit" class="btn btn-success w-100 py-3 fw-bold rounded-pill">ИЗПРАТИ И ПРИКЛЮЧИ</button>
            </form>
        </div></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwA-q2ce8R0tB3EusmgR8Uy_M0W2dfAQLrVfb96CDLg8-56ZvNU9LMLtsExEgZ_YfNRpw/exec";
        let user = null;

        async function login() {
            const email = document.getElementById('emailInput').value.toLowerCase().trim();
            if(!email) return;
            Swal.fire({title: 'Проверка...', didOpen: () => Swal.showLoading()});
            const resp = await fetch(`${API_URL}?action=getEmployeeOrders&email=${email}`);
            const data = await resp.json();
            Swal.close();
            
            if(data.error || !data.user) {
                Swal.fire('Грешка', 'Имейлът не е намерен в системата!', 'error');
            } else {
                user = data.user;
                document.getElementById('userName').innerText = "Здравей, " + user.Name;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appScreen').style.display = 'block';
                renderMyOrders(data.orders);
            }
        }

        function renderMyOrders(orders) {
            const container = document.getElementById('myOrders');
            if(orders.length === 0) {
                container.innerHTML = `<div class="alert alert-info">Нямате назначени поръчки.</div>`;
                return;
            }
            container.innerHTML = orders.map(o => `
                <div class="order-card">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="badge bg-primary">${o.Service}</span>
                        <span class="fw-bold">#${o.ID_Order}</span>
                    </div>
                    <h5 class="fw-bold mb-1">${o.Client_ID}</h5>
                    <p class="small mb-2"><i class="fas fa-clock text-warning"></i> ${o.Date} | ${o.Time_Start_Plan}</p>
                    <p class="small mb-1"><b>ОТ:</b> ${o.Address_Start}</p>
                    <p class="small mb-3"><b>ДО:</b> ${o.Address_End}</p>
                    <button class="btn btn-primary btn-action" onclick="clockIn('${o.ID_Order}')">СТАРТ НА РАБОТА</button>
                    <button class="btn btn-outline-danger btn-action" onclick="openChecklist('${o.ID_Order}')">КРАЙ НА РАБОТА</button>
                </div>
            `).join('');
        }

        async function clockIn(orderId) {
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const gps = `${pos.coords.latitude},${pos.coords.longitude}`;
                Swal.fire({title: 'Записване...', didOpen: () => Swal.showLoading()});
                await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "clockIn", OrderId: orderId, EmpId: user.ID_Emp, GPS: gps }) });
                Swal.fire('Старт!', 'Работният ден започна. Успех!', 'success');
            }, () => Swal.fire('Грешка', 'Включете GPS, за да започнете!', 'error'));
        }

        function openChecklist(orderId) {
            document.getElementById('checkOrderId').value = orderId;
            new bootstrap.Modal(document.getElementById('checkModal')).show();
        }

        document.getElementById('checkForm').onsubmit = async (e) => {
            e.preventDefault();
            const data = {
                action: "clockOut",
                OrderId: document.getElementById('checkOrderId').value,
                EmpId: user.ID_Emp,
                uniform: document.getElementById('q_uniform').value,
                workLoad: document.getElementById('q_load').value,
                teamWork: document.getElementById('q_team').value,
                clientRel: document.getElementById('q_client').value,
                notes: document.getElementById('q_notes').value
            };
            Swal.fire({title: 'Изпращане...', didOpen: () => Swal.showLoading()});
            await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
            Swal.fire('Готово!', 'Работата е приключена и записана.', 'success').then(() => location.reload());
        };
    </script>
</body>
</html>
