<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Местим Всичко - Екип</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <style>
        body { background: #f4f7f6; font-family: 'Segoe UI', sans-serif; padding-bottom: 70px; }
        .nav-bottom { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .nav-item { text-align: center; color: #6c757d; cursor: pointer; flex: 1; text-decoration: none; }
        .nav-item.active { color: #1a3c5a; font-weight: bold; }
        .order-card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; border-left: 5px solid #1a3c5a; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        #calendar { background: white; padding: 10px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); height: 75vh; }
        .chat-msg { background: white; padding: 10px; border-radius: 10px; margin-bottom: 5px; max-width: 85%; }
        .chat-mine { background: #dcf8c6; align-self: flex-end; margin-left: auto; }
        #loginScreen { height: 100vh; display: flex; align-items: center; justify-content: center; background: white; }
    </style>
</head>
<body>

    <div id="loginScreen">
        <div class="text-center p-4 w-100" style="max-width: 400px;">
            <i class="fas fa-truck-loading fa-4x text-primary mb-4"></i>
            <h2 class="fw-bold">Местим Всичко</h2>
            <input type="email" id="emailInput" class="form-control mb-3 py-3 rounded-pill text-center" placeholder="vashiat@email.com">
            <button class="btn btn-primary w-100 py-3 rounded-pill fw-bold" onclick="login()">ВХОД</button>
        </div>
    </div>

    <div id="appScreen" style="display:none;">
        <div class="p-3 bg-white shadow-sm d-flex justify-content-between">
            <h5 class="m-0 fw-bold" id="userName">...</h5>
            <i class="fas fa-sign-out-alt text-danger" onclick="location.reload()"></i>
        </div>

        <div class="container py-3">
            <!-- CALENDAR PAGE -->
            <section id="page-calendar">
                <div id="calendar"></div>
            </section>

            <!-- STATS PAGE -->
            <section id="page-stats" style="display:none;">
                <div class="row g-2 mb-3">
                    <div class="col-6"><div class="card p-3 text-center"><h6>Часове</h6><h3 id="statHours">0</h3></div></div>
                    <div class="col-6"><div class="card p-3 text-center text-success"><h6>За взимане</h6><h3 id="statUnpaid">0€</h3></div></div>
                </div>
                <h5>История на плащанията</h5>
                <div id="paymentHistory"></div>
            </section>

            <!-- CHAT PAGE -->
            <section id="page-chat" style="display:none;">
                <div id="chatBox" class="d-flex flex-column mb-3" style="height: 60vh; overflow-y: auto; padding: 10px;"></div>
                <div class="input-group"><input type="text" id="chatInput" class="form-control" placeholder="Напиши съобщение..."><button class="btn btn-primary" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button></div>
            </section>
        </div>

        <div class="nav-bottom">
            <div class="nav-item active" onclick="showPage('calendar', this)"><i class="fas fa-calendar-alt d-block"></i><small>График</small></div>
            <div class="nav-item" onclick="showPage('stats', this)"><i class="fas fa-euro-sign d-block"></i><small>Пари</small></div>
            <div class="nav-item" onclick="showPage('chat', this)"><i class="fas fa-comments d-block"></i><small>Чат</small></div>
        </div>
    </div>

    <!-- DETAILS MODAL -->
    <div class="modal fade" id="orderModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content p-4 rounded-4" id="modalContent"></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/bg.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwA-q2ce8R0tB3EusmgR8Uy_M0W2dfAQLrVfb96CDLg8-56ZvNU9LMLtsExEgZ_YfNRpw/exec";
        let appData = null;

        async function login() {
            const email = document.getElementById('emailInput').value.toLowerCase().trim();
            if(!email) return;
            Swal.fire({title: 'Зареждане...', didOpen: () => Swal.showLoading()});
            const resp = await fetch(`${API_URL}?action=getEmployeeOrders&email=${email}`);
            appData = await resp.json();
            Swal.close();
            if(appData.error) return Swal.fire('Грешка', 'Имейлът не е намерен!', 'error');
            
            document.getElementById('userName').innerText = appData.user.Name;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appScreen').style.display = 'block';
            initCalendar();
            loadStats();
            loadChat();
        }

        function showPage(p, el) {
            document.querySelectorAll('section').forEach(s => s.style.display = 'none');
            document.getElementById('page-' + p).style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
        }

        function initCalendar() {
            new FullCalendar.Calendar(document.getElementById('calendar'), {
                initialView: 'dayGridMonth', locale: 'bg',
                headerToolbar: { left: 'prev', center: 'title', right: 'next' },
                footerToolbar: { left: 'dayGridMonth,timeGridWeek,timeGridDay' },
                events: appData.orders.map(o => ({ title: o.Service, start: o.Date, color: '#1a3c5a', extendedProps: o })),
                eventClick: (info) => openOrderDetails(info.event.extendedProps)
            }).render();
        }

        function openOrderDetails(o) {
            document.getElementById('modalContent').innerHTML = `
                <h4 class="fw-bold text-primary mb-3">${o.Service}</h4>
                <p><b>Клиент:</b> ${o.Client_ID}<br><b>Тел:</b> <a href="tel:${o.Phone}">${o.Phone}</a></p>
                <p><b>Адрес:</b> ${o.Address_Start} &rarr; ${o.Address_End}</p>
                <p><b>Екип:</b> ${o.TeamMembers}</p>
                <p class="small text-muted"><b>Бележки:</b> ${o.Description || '-'}</p>
                <button class="btn btn-primary w-100 mb-2 py-3 rounded-pill fw-bold" onclick="clockAction('clockIn', '${o.ID_Order}')">СТАРТ</button>
                <button class="btn btn-danger w-100 py-3 rounded-pill fw-bold" onclick="clockAction('clockOut', '${o.ID_Order}')">КРАЙ</button>
            `;
            new bootstrap.Modal(document.getElementById('orderModal')).show();
        }

        function loadStats() {
            document.getElementById('statHours').innerText = appData.stats.totalHours;
            document.getElementById('statUnpaid').innerText = appData.stats.unpaidEur + " €";
            document.getElementById('paymentHistory').innerHTML = appData.stats.history.map(h => `
                <div class="card p-2 mb-1 small d-flex justify-content-between flex-row">
                    <span>${h.Clock_In.split(' ')[0]}</span>
                    <span class="fw-bold">${h.Total_Pay_Eur} €</span>
                    <span class="badge ${h.Payment_Status === 'Paid' ? 'bg-success' : 'bg-warning'}">${h.Payment_Status}</span>
                </div>
            `).join('');
        }

        function loadChat() {
            const box = document.getElementById('chatBox');
            box.innerHTML = appData.messages.map(m => `
                <div class="chat-msg ${m.Sender_ID === appData.user.Name ? 'chat-mine' : ''}">
                    <small class="fw-bold d-block">${m.Sender_ID}</small>
                    ${m.Message}
                </div>
            `).join('');
            box.scrollTop = box.scrollHeight;
        }

        async function sendMessage() {
            const text = document.getElementById('chatInput').value;
            if(!text) return;
            await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "sendMessage", senderName: appData.user.Name, text: text }) });
            document.getElementById('chatInput').value = '';
            // Симулираме изпращането за моментална реакция
            document.getElementById('chatBox').innerHTML += `<div class="chat-msg chat-mine"><small class="fw-bold d-block">Вие</small>${text}</div>`;
        }

        async function clockAction(action, id) {
            if(action === 'clockIn') {
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "clockIn", OrderId: id, EmpId: appData.user.ID_Emp, GPS: pos.coords.latitude + "," + pos.coords.longitude }) });
                    Swal.fire('Старт!', 'Работата започна.', 'success');
                });
            } else {
                // Тук би се отворил чеклиста, за краткост ползваме директен изход
                await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "clockOut", OrderId: id, EmpId: appData.user.ID_Emp, uniform: "Да", workLoad: "Нормална", teamWork: "Нормална", clientRel: "Нормална", notes: "" }) });
                Swal.fire('Край!', 'Работата приключи.', 'success').then(() => location.reload());
            }
        }
    </script>
</body>
</html>
