<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Местим Всичко - Екип</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        #loginScreen { height: 100vh; display: flex; align-items: center; justify-content: center; background: white; }
        .sidebar-user { background: #1a3c5a; color: white; padding: 20px; border-radius: 0 0 25px 25px; margin-bottom: 20px; }
        #calendar { background: white; padding: 10px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .fc-event { cursor: pointer !important; padding: 2px; }
        .btn-clock { border-radius: 50px; padding: 15px; font-weight: bold; width: 100%; margin-top: 10px; font-size: 1.1rem; }
    </style>
</head>
<body>

    <div id="loginScreen">
        <div class="text-center p-4" style="max-width: 400px; width: 100%;">
            <i class="fas fa-user-circle fa-4x text-primary mb-4"></i>
            <h3 class="fw-bold">Вход за служители</h3>
            <input type="email" id="emailInput" class="form-control mb-3 text-center py-3 rounded-pill" placeholder="vashiat@email.com">
            <button class="btn btn-primary w-100 py-3 rounded-pill fw-bold" onclick="login()">ВЛЕЗ В ГРАФИКА</button>
        </div>
    </div>

    <div id="appScreen" style="display:none;">
        <div class="sidebar-user shadow-sm d-flex justify-content-between align-items-center">
            <div><small class="opacity-75 d-block">Добре дошли,</small><h4 class="m-0 fw-bold" id="userName">...</h4></div>
            <button class="btn btn-sm btn-light rounded-pill" onclick="location.reload()">Изход</button>
        </div>
        
        <div class="container">
            <div id="calendar" class="mb-4"></div>
        </div>
    </div>

    <!-- MODAL: ORDER DETAILS & CLOCK -->
    <div class="modal fade" id="orderModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content p-4 border-0 shadow-lg rounded-4">
        <div id="modalContent"></div>
    </div></div></div>

    <!-- MODAL: CHECKLIST -->
    <div class="modal fade" id="checkModal" data-bs-backdrop="static" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content p-4">
        <h4 class="text-center mb-4">Приключване на работа</h4>
        <form id="checkForm">
            <input type="hidden" id="checkOrderId">
            <label class="small fw-bold mb-1">Униформа?</label><select class="form-select mb-3" id="q_uniform"><option>Да</option><option>Не</option></select>
            <label class="small fw-bold mb-1">Натоварване?</label><select class="form-select mb-3" id="q_load"><option>Лека</option><option>Нормална</option><option>Тежка</option></select>
            <label class="small fw-bold mb-1">Екипна работа?</label><select class="form-select mb-3" id="q_team"><option>Лека</option><option>Нормална</option><option>Трудна</option></select>
            <label class="small fw-bold mb-1">Клиенти?</label><select class="form-select mb-3" id="q_client"><option>Лека</option><option>Нормална</option><option>Трудна</option></select>
            <textarea class="form-control mb-3" id="q_notes" placeholder="Бележки..."></textarea>
            <button type="submit" class="btn btn-success w-100 py-3 rounded-pill fw-bold">ИЗПРАТИ И ПРИКЛЮЧИ</button>
        </form>
    </div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/bg.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwA-q2ce8R0tB3EusmgR8Uy_M0W2dfAQLrVfb96CDLg8-56ZvNU9LMLtsExEgZ_YfNRpw/exec";
        let user = null;
        let orders = [];

        async function login() {
            const email = document.getElementById('emailInput').value.toLowerCase().trim();
            if(!email) return;
            Swal.fire({title: 'Зареждане...', didOpen: () => Swal.showLoading()});
            try {
                const resp = await fetch(`${API_URL}?action=getEmployeeOrders&email=${email}`);
                const data = await resp.json();
                Swal.close();
                if(data.error) throw new Error();
                
                user = data.user;
                orders = data.orders;
                document.getElementById('userName').innerText = user.Name;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appScreen').style.display = 'block';
                initCalendar();
            } catch(e) { Swal.fire('Грешка', 'Имейлът не е намерен!', 'error'); }
        }

        function initCalendar() {
            const el = document.getElementById('calendar');
            const calendar = new FullCalendar.Calendar(el, {
                initialView: 'dayGridMonth', locale: 'bg',
                headerToolbar: { left: 'prev', center: 'title', right: 'next' },
                events: orders.map(o => ({
                    title: `${o.Time_Start_Plan} | ${o.Service}`,
                    start: o.Date,
                    color: '#1a3c5a',
                    extendedProps: o
                })),
                eventClick: (info) => openOrderDetails(info.event.extendedProps)
            });
            calendar.render();
        }

        function openOrderDetails(o) {
            document.getElementById('modalContent').innerHTML = `
                <h4 class="fw-bold text-primary mb-3">${o.Service}</h4>
                <div class="mb-3">
                    <p class="mb-1"><b>Клиент:</b> ${o.Client_ID}</p>
                    <p class="mb-1"><b>Тел:</b> <a href="tel:${o.Phone}">${o.Phone}</a></p>
                    <p class="mb-1"><b>Час:</b> ${o.Time_Start_Plan} ч.</p>
                    <p class="mb-1"><b>ОТ:</b> ${o.Address_Start}</p>
                    <p class="mb-1"><b>ДО:</b> ${o.Address_End}</p>
                    <p class="small text-muted"><b>Бележки:</b> ${o.Description || '-'}</p>
                </div>
                <button class="btn btn-primary btn-clock" onclick="clockAction('clockIn', '${o.ID_Order}')">СТАРТ НА РАБОТА</button>
                <button class="btn btn-outline-danger btn-clock" onclick="showChecklist('${o.ID_Order}')">КРАЙ НА РАБОТА</button>
            `;
            new bootstrap.Modal(document.getElementById('orderModal')).show();
        }

        async function clockAction(action, orderId) {
            if(action === 'clockIn') {
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const gps = `${pos.coords.latitude},${pos.coords.longitude}`;
                    Swal.fire({title: 'Записване...', didOpen: () => Swal.showLoading()});
                    await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "clockIn", OrderId: orderId, EmpId: user.ID_Emp, GPS: gps }) });
                    Swal.fire('Успех!', 'Работата започна.', 'success');
                }, () => Swal.fire('Грешка', 'Включете GPS!', 'error'));
            }
        }

        function showChecklist(orderId) {
            bootstrap.Modal.getInstance(document.getElementById('orderModal')).hide();
            document.getElementById('checkOrderId').value = orderId;
            new bootstrap.Modal(document.getElementById('checkModal')).show();
        }

        document.getElementById('checkForm').onsubmit = async (e) => {
            e.preventDefault();
            const data = {
                action: "clockOut", OrderId: document.getElementById('checkOrderId').value, EmpId: user.ID_Emp,
                uniform: document.getElementById('q_uniform').value, workLoad: document.getElementById('q_load').value,
                teamWork: document.getElementById('q_team').value, clientRel: document.getElementById('q_client').value,
                notes: document.getElementById('q_notes').value
            };
            Swal.fire({title: 'Изпращане...', didOpen: () => Swal.showLoading()});
            await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
            Swal.fire('Готово!', 'Работата е приключена.', 'success').then(() => location.reload());
        };
    </script>
</body>
</html>
